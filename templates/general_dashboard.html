<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>General Dashboard</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        h2 { text-align: center; }

        /* Table styling */
        table#expTable { 
            width: 100%; 
            border-collapse: collapse; 
            margin-top: 20px; 
        }
        table#expTable th, table#expTable td { 
            border: 1px solid #ccc; 
            padding: 8px; 
            text-align: center; 
        }
        table#expTable th { background-color: #f4f4f4; }
        table#expTable tr.over { background-color: #ffcccc; }

        #searchBar { width: 100%; padding: 8px; margin-bottom: 10px; }

        /* Feedback Modal styling */
        #feedbackModal {
            display:none; 
            position:fixed; 
            top:0; left:0; 
            width:100%; height:100%; 
            background: rgba(0,0,0,0.5); 
            justify-content:center; 
            align-items:center;
            z-index: 1000;
        }
        #feedbackModal div {
            background:#fff; 
            padding:20px; 
            border-radius:8px; 
            width:300px; 
            text-align:center; 
            position:relative;
        }
        #feedbackModal textarea { width:100%; margin-bottom:10px; }
        #feedbackModal span#closeModal { position:absolute; top:5px; right:10px; cursor:pointer; font-size:20px; }

        /* Chatbot Panel styling */
        #chatPanel {
            display:none; 
            position:fixed; 
            bottom:80px; right:20px; 
            width:320px; height:450px; 
            background:#fff; 
            border:1px solid #ccc; 
            border-radius:8px; 
            box-shadow:0 0 10px rgba(0,0,0,0.2); 
            flex-direction:column; 
            overflow:hidden; 
            z-index:1001;
        }
        #chatPanel #chatHeader { 
            background:#28a745; 
            color:white; 
            padding:10px; 
        }
        #chatPanel #chatHeader span { float:right; cursor:pointer; }
        #chatBody { padding:10px; height:320px; overflow-y:auto; }
        #chatPanel select, #chatPanel input, #chatPanel button { margin-bottom:5px; }
    </style>
</head>
<body>
    <h2>General Dashboard</h2>

    <input type="text" id="searchBar" placeholder="Search by category name...">
    <table id="expTable">
        <thead>
            <tr>
                <th>Category</th>
                <th>Budget Limit</th>
                <th>Amount Spent</th>
                <th>Remaining</th>
            </tr>
        </thead>
        <tbody>
            {% for exp in expenditures %}
            <tr class="{% if exp.spent > exp.budget %}over{% endif %}">
                <td>{{ exp.name }}</td>
                <td>{{ "{:,.2f}".format(exp.budget) }}</td>
                <td>{{ "{:,.2f}".format(exp.spent) }}</td>
                <td>{{ "{:,.2f}".format(exp.remaining) }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <!-- Feedback Button -->
    <button id="feedbackBtn" style="margin-top:20px; padding:10px 20px;">Give Feedback</button>

    <!-- Feedback Modal -->
    <div id="feedbackModal">
        <div>
            <span id="closeModal">&times;</span>
            <h3>Feedback</h3>
            <textarea id="feedbackText" rows="4" placeholder="Write your feedback..."></textarea>
            <button id="submitFeedback" style="padding:8px 16px;">Submit</button>
        </div>
    </div>

    <!-- Chatbot Button -->
    <button id="chatBtn" style="position:fixed; bottom:20px; right:20px; padding:10px 20px; border-radius:8px; background:#28a745; color:white; border:none; cursor:pointer;">Chat</button>

    <!-- Chatbot Panel -->
    <div id="chatPanel">
        <div id="chatHeader">Chat Helper <span id="closeChat">&times;</span></div>
        <div id="chatBody"></div>

        <!-- Dropdown for example questions -->
        <select id="exampleQuestions" style="width:100%; padding:5px;">
            <option value="">Select a question...</option>
            <option value="Where did the professor budget go?">Where did the professor budget go?</option>
            <option value="How much is spent on cleaning staff?">How much is spent on cleaning staff?</option>
            <option value="Which categories are over budget?">Which categories are over budget?</option>
            <option value="How much money is remaining in library budget?">How much money is remaining in library budget?</option>
            <option value="Show all budget vs spent for all categories">Show all budget vs spent for all categories</option>
        </select>

        <div style="display:flex; padding:10px; border-top:1px solid #ccc;">
            <input type="text" id="chatInput" placeholder="Ask a question..." style="flex:1; padding:5px;">
            <button id="sendBtn" style="padding:5px 10px; margin-left:5px;">Send</button>
        </div>
    </div>

    <script>
        // Search functionality
        const searchInput = document.getElementById('searchBar');
        const table = document.getElementById('expTable');
        const rows = table.getElementsByTagName('tr');
        searchInput.addEventListener('keyup', function() {
            const filter = searchInput.value.toLowerCase();
            for (let i = 1; i < rows.length; i++) {
                const td = rows[i].getElementsByTagName('td')[0];
                rows[i].style.display = td && td.textContent.toLowerCase().includes(filter) ? '' : 'none';
            }
        });

        // Feedback Modal
        const feedbackBtn = document.getElementById('feedbackBtn');
        const feedbackModal = document.getElementById('feedbackModal');
        const closeModal = document.getElementById('closeModal');
        const submitFeedback = document.getElementById('submitFeedback');
        const feedbackText = document.getElementById('feedbackText');
        feedbackBtn.addEventListener('click', () => feedbackModal.style.display = 'flex');
        closeModal.addEventListener('click', () => feedbackModal.style.display = 'none');
        submitFeedback.addEventListener('click', () => {
            const feedback = feedbackText.value.trim();
            if(feedback === "") { alert("Please enter feedback!"); return; }
            fetch('/api/feedback', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ feedback })
            })
            .then(res => res.json())
            .then(data => { alert(data.message); feedbackModal.style.display = 'none'; feedbackText.value = ''; })
            .catch(err => alert("Error submitting feedback!"));
        });
        window.addEventListener('click', (e) => { if(e.target === feedbackModal) feedbackModal.style.display = 'none'; });

        // Chatbot functionality
        const chatBtn = document.getElementById('chatBtn');
        const chatPanel = document.getElementById('chatPanel');
        const closeChat = document.getElementById('closeChat');
        const chatBody = document.getElementById('chatBody');
        const chatInput = document.getElementById('chatInput');
        const sendBtn = document.getElementById('sendBtn');
        const exampleQuestions = document.getElementById('exampleQuestions');

        chatBtn.addEventListener('click', () => chatPanel.style.display = 'flex');
        closeChat.addEventListener('click', () => chatPanel.style.display = 'none');

        function appendMessage(sender, message) {
            const msgDiv = document.createElement('div');
            msgDiv.style.margin = '5px 0';
            msgDiv.style.textAlign = sender === 'user' ? 'right' : 'left';
            msgDiv.innerHTML = `<strong>${sender}:</strong> ${message}`;
            chatBody.appendChild(msgDiv);
            chatBody.scrollTop = chatBody.scrollHeight;
        }

        function sendMessage(question=null) {
            const userQuestion = question || chatInput.value.trim();
            if (!userQuestion) return;
            appendMessage('user', userQuestion);
            chatInput.value = '';
            fetch('/api/chat', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ question: userQuestion })
            })
            .then(res => res.json())
            .then(data => appendMessage('bot', data.answer))
            .catch(err => appendMessage('bot', 'Error processing your request.'));
        }

        sendBtn.addEventListener('click', () => sendMessage());
        chatInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') sendMessage(); });
        exampleQuestions.addEventListener('change', () => { if (exampleQuestions.value) sendMessage(exampleQuestions.value); });

    </script>
</body>
</html>
     
